{% extends 'dashboard/base.html' %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row justify-content-center">
        <div class="col-lg-8 col-md-10">
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="mb-1">
                        <i class="fas fa-edit text-info"></i> {{ title }}
                    </h2>
                    <p class="text-muted mb-0">
                        {% if user_access %}
                            Edit access permissions for {{ user_access.user.username }} on {{ user_access.menu_item.display_name }}
                        {% else %}
                            Create new access permissions for a user
                        {% endif %}
                    </p>
                </div>
                <div>
                    <a href="{% url 'user_menu_access_list' %}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left"></i> Back to List
                    </a>
                </div>
            </div>

            <!-- Form Card -->
            <div class="card shadow">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-form"></i> Access Permission Details
                    </h5>
                </div>
                <div class="card-body">
                    <form method="post" id="accessForm">
                        {% csrf_token %}
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.user.id_for_label }}" class="form-label fw-bold">
                                    <i class="fas fa-user text-primary"></i> User *
                                </label>
                                {{ form.user }}
                                {% if form.user.help_text %}
                                    <div class="form-text">{{ form.user.help_text }}</div>
                                {% endif %}
                                {% if form.user.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.user.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>

                            <div class="col-md-6 mb-3">
                                <label for="{{ form.menu_item.id_for_label }}" class="form-label fw-bold">
                                    <i class="fas fa-list text-success"></i> Menu Item *
                                </label>
                                {{ form.menu_item }}
                                {% if form.menu_item.help_text %}
                                    <div class="form-text">{{ form.menu_item.help_text }}</div>
                                {% endif %}
                                {% if form.menu_item.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.menu_item.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.role.id_for_label }}" class="form-label fw-bold">
                                    <i class="fas fa-user-tag text-warning"></i> Role (Optional)
                                </label>
                                {{ form.role }}
                                {% if form.role.help_text %}
                                    <div class="form-text">{{ form.role.help_text }}</div>
                                {% endif %}
                                {% if form.role.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.role.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Permissions -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <label class="form-label fw-bold">
                                    <i class="fas fa-key text-danger"></i> Permissions
                                </label>
                                <div class="permissions-container">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="form-check">
                                                {{ form.can_view }}
                                                <label class="form-check-label" for="{{ form.can_view.id_for_label }}">
                                                    View
                                                </label>
                                                <small class="form-text text-muted d-block">
                                                    User can see and access this menu item
                                                </small>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-check">
                                                {{ form.can_create }}
                                                <label class="form-check-label" for="{{ form.can_create.id_for_label }}">
                                                    Create
                                                </label>
                                                <small class="form-text text-muted d-block">
                                                    User can create new records
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row mt-2">
                                        <div class="col-md-6">
                                            <div class="form-check">
                                                {{ form.can_edit }}
                                                <label class="form-check-label" for="{{ form.can_edit.id_for_label }}">
                                                    Edit
                                                </label>
                                                <small class="form-text text-muted d-block">
                                                    User can modify existing records
                                                </small>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-check">
                                                {{ form.can_delete }}
                                                <label class="form-check-label" for="{{ form.can_delete.id_for_label }}">
                                                    Delete
                                                </label>
                                                <small class="form-text text-muted d-block">
                                                    User can remove records
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row mt-2">
                                        <div class="col-md-6">
                                            <div class="form-check">
                                                {{ form.can_approve }}
                                                <label class="form-check-label" for="{{ form.can_approve.id_for_label }}">
                                                    Approve
                                                </label>
                                                <small class="form-text text-muted d-block">
                                                    User can approve workflows
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="row">
                            <div class="col-12">
                                <div class="d-flex justify-content-between">
                                    <button type="button" class="btn btn-outline-secondary" onclick="resetForm()">
                                        <i class="fas fa-undo"></i> Reset Form
                                    </button>
                                    <div>
                                        <a href="{% url 'user_menu_access_list' %}" class="btn btn-outline-primary me-2">
                                            <i class="fas fa-times"></i> Cancel
                                        </a>
                                        <button type="submit" class="btn btn-info" id="submitBtn">
                                            <i class="fas fa-save"></i> 
                                            {% if user_access %}Update{% else %}Create{% endif %} Access
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Help Information -->
            <div class="card shadow mt-4">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-question-circle text-info"></i> Permission Levels
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-primary">Basic Permissions:</h6>
                            <ul class="mb-0">
                                <li><strong>View:</strong> Access to see and navigate to the menu item</li>
                                <li><strong>Create:</strong> Ability to add new records or entries</li>
                                <li><strong>Edit:</strong> Modify existing records and data</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-success">Advanced Permissions:</h6>
                            <ul class="mb-0">
                                <li><strong>Delete:</strong> Remove records from the system</li>
                                <li><strong>Approve:</strong> Approve workflows and processes</li>
                                <li><strong>Role:</strong> Assign a role for additional context</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.form-label {
    color: #495057;
    margin-bottom: 0.5rem;
}

.form-select, .form-control {
    border-radius: 0.375rem;
    border: 1px solid #ced4da;
    transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
}

.form-select:focus, .form-control:focus {
    border-color: #86b7fe;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
}

.permissions-container {
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    padding: 1rem;
    background-color: #f8f9fa;
}

.form-check-input:checked {
    background-color: #198754;
    border-color: #198754;
}

.form-check-label {
    color: #495057;
    font-weight: 500;
}

.card {
    border: none;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
}

.card-header {
    background-color: #f8f9fc;
    border-bottom: 1px solid #e3e6f0;
}

.btn {
    border-radius: 0.375rem;
    font-weight: 500;
}

.btn-info {
    background-color: #0dcaf0;
    border-color: #0dcaf0;
}

.btn-info:hover {
    background-color: #31d2f2;
    border-color: #25cff2;
}

.form-text {
    color: #6c757d;
    font-size: 0.875rem;
}

.invalid-feedback {
    color: #dc3545;
    font-size: 0.875rem;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('accessForm');
    const submitBtn = document.getElementById('submitBtn');

    // Form validation
    form.addEventListener('submit', function(e) {
        const user = document.getElementById('{{ form.user.id_for_label }}').value;
        const menuItem = document.getElementById('{{ form.menu_item.id_for_label }}').value;
        const permissions = document.querySelectorAll('input[name="can_view"], input[name="can_create"], input[name="can_edit"], input[name="can_delete"], input[name="can_approve"]');
        const hasPermission = Array.from(permissions).some(checkbox => checkbox.checked);

        if (!user) {
            e.preventDefault();
            alert('Please select a user.');
            return;
        }

        if (!menuItem) {
            e.preventDefault();
            alert('Please select a menu item.');
            return;
        }

        if (!hasPermission) {
            e.preventDefault();
            alert('Please select at least one permission.');
            return;
        }

        // Disable submit button to prevent double submission
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
    });
});

function resetForm() {
    if (confirm('Are you sure you want to reset the form? All changes will be lost.')) {
        document.getElementById('accessForm').reset();
    }
}
</script>
{% endblock %}
