{% extends 'dashboard/base.html' %}
{% load static %}
{% load custom_filters %}

{% block title %}User Menu Access Control{% endblock %}

{% block extra_head %}
<style>
    .menu-access-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
    }
    
    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        padding-bottom: 15px;
        border-bottom: 2px solid #667eea;
    }
    
    .page-title {
        font-size: 2rem;
        font-weight: 700;
        color: #2c3e50;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 15px;
    }
    
    .page-icon {
        width: 50px;
        height: 50px;
        background: linear-gradient(135deg, #667eea, #764ba2);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.5rem;
    }
    
    .user-table {
        background: white;
        border-radius: 10px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        overflow: hidden;
    }
    
    .table-header {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        padding: 20px;
    }
    
    .table-title {
        font-size: 1.5rem;
        font-weight: 600;
        margin: 0;
    }
    
    .table {
        margin: 0;
        min-width: 1400px;
    }
    
    .table th,
    .table td {
        white-space: nowrap;
        min-width: 120px;
    }
    
    .user-info {
        min-width: 150px;
    }
    
    .table th {
        background: #f8f9fa;
        border: none;
        padding: 15px;
        font-weight: 600;
        color: #2c3e50;
        text-align: center;
        vertical-align: middle;
    }
    
    .table td {
        border: none;
        padding: 15px;
        text-align: center;
        vertical-align: middle;
        border-bottom: 1px solid #e9ecef;
    }
    
    .user-info {
        text-align: left;
    }
    
    .user-name {
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 5px;
    }
    
    .user-email {
        font-size: 0.875rem;
        color: #6c757d;
    }
    
    .toggle-switch {
        position: relative;
        display: inline-block;
        width: 60px;
        height: 30px;
        cursor: pointer;
        user-select: none;
    }
    
    .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
        position: absolute;
        pointer-events: none;
    }
    
    .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: .3s ease;
        border-radius: 30px;
        box-shadow: inset 0 1px 3px rgba(0,0,0,0.2);
    }
    
    .slider:before {
        position: absolute;
        content: "";
        height: 22px;
        width: 22px;
        left: 4px;
        bottom: 4px;
        background-color: white;
        transition: .3s ease;
        border-radius: 50%;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    
    .toggle-switch:hover .slider {
        background-color: #b3b3b3;
    }
    
    .toggle-switch:hover input:checked + .slider {
        background-color: #218838;
    }
    
    input:checked + .slider {
        background-color: #28a745;
    }
    
    input:checked + .slider:before {
        transform: translateX(30px);
    }
    
    .toggle-switch:active .slider:before {
        width: 26px;
    }
    
    .menu-label {
        font-size: 0.875rem;
        font-weight: 500;
        color: #495057;
        margin-bottom: 5px;
    }
    
    .status-badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
    }
    
    .status-enabled {
        background-color: #d4edda;
        color: #155724;
    }
    
    .status-disabled {
        background-color: #f8d7da;
        color: #721c24;
    }
    
    .btn-back {
        background: #6c757d;
        color: white;
        padding: 10px 20px;
        border-radius: 8px;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        transition: all 0.3s ease;
    }
    
    .btn-back:hover {
        background: #5a6268;
        color: white;
        text-decoration: none;
        transform: translateY(-1px);
    }
    
    .alert {
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        border: 1px solid transparent;
    }
    
    .alert-success {
        background-color: #d4edda;
        color: #155724;
        border-color: #c3e6cb;
    }
    
    .alert-danger {
        background-color: #f8d7da;
        color: #721c24;
        border-color: #f5c6cb;
    }
</style>
{% endblock %}

{% block content %}
<div class="menu-access-container">
    <!-- Page Header -->
    <div class="page-header">
        <h1 class="page-title">
            <div class="page-icon">
                <i class="fas fa-users-cog"></i>
            </div>
            User Menu Access Control
        </h1>
        <a href="{% url 'dashboard' %}" class="btn-back">
            <i class="fas fa-arrow-left"></i>
            Back to Dashboard
        </a>
    </div>

    <!-- Messages -->
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }}">
                <i class="fas fa-{% if message.tags == 'success' %}check-circle{% elif message.tags == 'error' %}exclamation-circle{% else %}info-circle{% endif %} me-2"></i>
                {{ message }}
            </div>
        {% endfor %}
    {% endif %}

    <!-- User Menu Access Table -->
    <div class="user-table">
        <div class="table-header">
            <h2 class="table-title">Control User Menu Access</h2>
        </div>
        
        <div class="table-responsive">
            <table class="table">
                <thead>
                    <tr>
                        <th style="width: 15%;">User Information</th>
                        <th style="width: 12%;">SPO Menu</th>
                        <th style="width: 12%;">CFA Menu</th>
                        <th style="width: 12%;">Transport Menu</th>
                        <th style="width: 12%;">Approval Menu</th>
                        <th style="width: 12%;">Approval Workflow</th>
                        <th style="width: 12%;">Report</th>
                        <th style="width: 12%;">Mail Reminder</th>
                        <th style="width: 12%;">User Management</th>
                        <th style="width: 12%;">Menu Access Control</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in users %}
                    <tr>
                        <td class="user-info">
                            <div class="user-name">{{ user.get_full_name|default:user.username }}</div>
                            <div class="user-email">{{ user.email }}</div>
                        </td>
                        
                        <td>
                            <div class="menu-label">SPO Menu</div>
                            <label class="toggle-switch">
                                <input type="checkbox" 
                                       class="menu-toggle" 
                                       data-user-id="{{ user.id }}" 
                                       data-menu-type="spo_menu_enabled"
                                       {% if user_menu_access|get_item:user.id|get_item:'spo_menu' %}checked{% endif %}>
                                <span class="slider"></span>
                            </label>
                            <div class="status-badge {% if user_menu_access|get_item:user.id|get_item:'spo_menu' %}status-enabled{% else %}status-disabled{% endif %}">
                                {% if user_menu_access|get_item:user.id|get_item:'spo_menu' %}Enabled{% else %}Disabled{% endif %}
                            </div>
                        </td>
                        
                        <td>
                            <div class="menu-label">CFA Menu</div>
                            <label class="toggle-switch">
                                <input type="checkbox" 
                                       class="menu-toggle" 
                                       data-user-id="{{ user.id }}" 
                                       data-menu-type="cfa_menu_enabled"
                                       {% if user_menu_access|get_item:user.id|get_item:'cfa_menu' %}checked{% endif %}>
                                <span class="slider"></span>
                            </label>
                            <div class="status-badge {% if user_menu_access|get_item:user.id|get_item:'cfa_menu' %}status-enabled{% else %}status-disabled{% endif %}">
                                {% if user_menu_access|get_item:user.id|get_item:'cfa_menu' %}Enabled{% else %}Disabled{% endif %}
                            </div>
                        </td>
                        
                        <td>
                            <div class="menu-label">Transport Menu</div>
                            <label class="toggle-switch">
                                <input type="checkbox" 
                                       class="menu-toggle" 
                                       data-user-id="{{ user.id }}" 
                                       data-menu-type="transport_menu_enabled"
                                       {% if user_menu_access|get_item:user.id|get_item:'transport_menu' %}checked{% endif %}>
                                <span class="slider"></span>
                            </label>
                            <div class="status-badge {% if user_menu_access|get_item:user.id|get_item:'transport_menu' %}status-enabled{% else %}status-disabled{% endif %}">
                                {% if user_menu_access|get_item:user.id|get_item:'transport_menu' %}Enabled{% else %}Disabled{% endif %}
                            </div>
                        </td>
                        
                        <td>
                            <div class="menu-label">Approval Menu</div>
                            <label class="toggle-switch">
                                <input type="checkbox" 
                                       class="menu-toggle" 
                                       data-user-id="{{ user.id }}" 
                                       data-menu-type="approval_menu_enabled"
                                       {% if user_menu_access|get_item:user.id|get_item:'approval_menu' %}checked{% endif %}>
                                <span class="slider"></span>
                            </label>
                            <div class="status-badge {% if user_menu_access|get_item:user.id|get_item:'approval_menu' %}status-enabled{% else %}status-disabled{% endif %}">
                                {% if user_menu_access|get_item:user.id|get_item:'approval_menu' %}Enabled{% else %}Disabled{% endif %}
                            </div>
                        </td>
                        
                        <td>
                            <div class="menu-label">Approval Workflow</div>
                            <label class="toggle-switch">
                                <input type="checkbox" 
                                       class="menu-toggle" 
                                       data-user-id="{{ user.id }}" 
                                       data-menu-type="approval_workflow_enabled"
                                       {% if user_menu_access|get_item:user.id|get_item:'approval_workflow' %}checked{% endif %}>
                                <span class="slider"></span>
                            </label>
                            <div class="status-badge {% if user_menu_access|get_item:user.id|get_item:'approval_workflow' %}status-enabled{% else %}status-disabled{% endif %}">
                                {% if user_menu_access|get_item:user.id|get_item:'approval_workflow' %}Enabled{% else %}Disabled{% endif %}
                            </div>
                        </td>
                        
                        <td>
                            <div class="menu-label">Report</div>
                            <label class="toggle-switch">
                                <input type="checkbox" 
                                       class="menu-toggle" 
                                       data-user-id="{{ user.id }}" 
                                       data-menu-type="report_enabled"
                                       {% if user_menu_access|get_item:user.id|get_item:'report' %}checked{% endif %}>
                                <span class="slider"></span>
                            </label>
                            <div class="status-badge {% if user_menu_access|get_item:user.id|get_item:'report' %}status-enabled{% else %}status-disabled{% endif %}">
                                {% if user_menu_access|get_item:user.id|get_item:'report' %}Enabled{% else %}Disabled{% endif %}
                            </div>
                        </td>
                        
                        <td>
                            <div class="menu-label">Mail Reminder</div>
                            <label class="toggle-switch">
                                <input type="checkbox" 
                                       class="menu-toggle" 
                                       data-user-id="{{ user.id }}" 
                                       data-menu-type="mail_reminder_enabled"
                                       {% if user_menu_access|get_item:user.id|get_item:'mail_reminder' %}checked{% endif %}>
                                <span class="slider"></span>
                            </label>
                            <div class="status-badge {% if user_menu_access|get_item:user.id|get_item:'mail_reminder' %}status-enabled{% else %}status-disabled{% endif %}">
                                {% if user_menu_access|get_item:user.id|get_item:'mail_reminder' %}Enabled{% else %}Disabled{% endif %}
                            </div>
                        </td>
                        
                        <td>
                            <div class="menu-label">User Management</div>
                            <label class="toggle-switch">
                                <input type="checkbox" 
                                       class="menu-toggle" 
                                       data-user-id="{{ user.id }}" 
                                       data-menu-type="user_management_enabled"
                                       {% if user_menu_access|get_item:user.id|get_item:'user_management' %}checked{% endif %}>
                                <span class="slider"></span>
                            </label>
                            <div class="status-badge {% if user_menu_access|get_item:user.id|get_item:'user_management' %}status-enabled{% else %}status-disabled{% endif %}">
                                {% if user_menu_access|get_item:user.id|get_item:'user_management' %}Enabled{% else %}Disabled{% endif %}
                            </div>
                        </td>
                        
                        <td>
                            <div class="menu-label">Menu Access Control</div>
                            <label class="toggle-switch">
                                <input type="checkbox" 
                                       class="menu-toggle" 
                                       data-user-id="{{ user.id }}" 
                                       data-menu-type="user_menu_access_control_enabled"
                                       {% if user_menu_access|get_item:user.id|get_item:'user_menu_access_control' %}checked{% endif %}>
                                <span class="slider"></span>
                            </label>
                            <div class="status-badge {% if user_menu_access|get_item:user.id|get_item:'user_menu_access_control' %}status-enabled{% else %}status-disabled{% endif %}">
                                {% if user_menu_access|get_item:user.id|get_item:'user_menu_access_control' %}Enabled{% else %}Disabled{% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Handle menu toggle switches
    const toggleSwitches = document.querySelectorAll('.menu-toggle');
    
    toggleSwitches.forEach(toggle => {
        // Add click event listener to the label for better UX
        const label = toggle.closest('.toggle-switch');
        
        label.addEventListener('click', function(e) {
            // Prevent double-triggering
            e.preventDefault();
            
            // Toggle the checkbox state
            const checkbox = this.querySelector('input[type="checkbox"]');
            checkbox.checked = !checkbox.checked;
            
            // Trigger the change event
            const changeEvent = new Event('change', { bubbles: true });
            checkbox.dispatchEvent(changeEvent);
        });
        
        // Handle change event
        toggle.addEventListener('change', function() {
            const userId = this.dataset.userId;
            const menuType = this.dataset.menuType;
            const enabled = this.checked;
            
            console.log(`Toggle changed: ${menuType} for user ${userId} = ${enabled}`);
            
            // Update the status badge immediately
            const statusBadge = this.closest('td').querySelector('.status-badge');
            if (enabled) {
                statusBadge.textContent = 'Enabled';
                statusBadge.className = 'status-badge status-enabled';
            } else {
                statusBadge.textContent = 'Disabled';
                statusBadge.className = 'status-badge status-disabled';
            }
            
            // Send AJAX request to update the database
            updateMenuAccess(userId, menuType, enabled);
        });
    });
    
    function updateMenuAccess(userId, menuType, enabled) {
        const formData = new FormData();
        formData.append('user_id', userId);
        formData.append('menu_type', menuType);
        formData.append('enabled', enabled);
        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
        
        console.log(`Sending request: user_id=${userId}, menu_type=${menuType}, enabled=${enabled}`);
        
        fetch('{% url "update_user_menu_access" %}', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log('Menu access updated successfully:', data.message);
                // Show success message
                showMessage('Menu access updated successfully!', 'success');
            } else {
                console.error('Error updating menu access:', data.message);
                showMessage('Error updating menu access: ' + data.message, 'error');
                // Revert the toggle if there was an error
                const toggle = document.querySelector(`[data-user-id="${userId}"][data-menu-type="${menuType}"]`);
                if (toggle) {
                    toggle.checked = !enabled;
                    // Update status badge back
                    const statusBadge = toggle.closest('td').querySelector('.status-badge');
                    if (statusBadge) {
                        if (!enabled) {
                            statusBadge.textContent = 'Enabled';
                            statusBadge.className = 'status-badge status-enabled';
                        } else {
                            statusBadge.textContent = 'Disabled';
                            statusBadge.className = 'status-badge status-disabled';
                        }
                    }
                }
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showMessage('Network error occurred. Please try again.', 'error');
            // Revert the toggle if there was an error
            const toggle = document.querySelector(`[data-user-id="${userId}"][data-menu-type="${menuType}"]`);
            if (toggle) {
                toggle.checked = !enabled;
                // Update status badge back
                const statusBadge = toggle.closest('td').querySelector('.status-badge');
                if (statusBadge) {
                    if (!enabled) {
                        statusBadge.textContent = 'Enabled';
                        statusBadge.className = 'status-badge status-enabled';
                    } else {
                        statusBadge.textContent = 'Disabled';
                        statusBadge.className = 'status-badge status-disabled';
                    }
                }
            }
        });
    }
    
    function showMessage(message, type) {
        // Create a temporary message element
        const messageDiv = document.createElement('div');
        messageDiv.className = `alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show`;
        messageDiv.innerHTML = `
            <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'} me-2"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        // Insert at the top of the container
        const container = document.querySelector('.menu-access-container');
        container.insertBefore(messageDiv, container.firstChild);
        
        // Auto-remove after 5 seconds
        setTimeout(() => {
            if (messageDiv.parentNode) {
                messageDiv.remove();
            }
        }, 5000);
    }
});
</script>
{% endblock %}
