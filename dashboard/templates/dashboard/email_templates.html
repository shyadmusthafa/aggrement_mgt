{% extends 'dashboard/base.html' %}
{% load static %}

{% block title %}Email Template Manager - Data Management System{% endblock %}

{% block content %}
<style>
    .template-manager-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 2rem;
        background: #f8fafc;
        min-height: 100vh;
    }

    .template-header {
        background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 50%, #1e40af 100%);
        color: white;
        padding: 3rem 2rem;
        border-radius: 20px;
        margin-bottom: 2rem;
        box-shadow: 0 20px 40px rgba(30, 58, 138, 0.3);
        text-align: center;
    }

    .template-title {
        font-size: 2.5rem;
        font-weight: 800;
        margin-bottom: 1rem;
    }

    .template-subtitle {
        font-size: 1.1rem;
        opacity: 0.9;
    }

    .template-grid {
        display: grid;
        grid-template-columns: 300px 1fr;
        gap: 2rem;
        margin-bottom: 2rem;
    }

    .template-sidebar {
        background: white;
        border-radius: 20px;
        padding: 2rem;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        border: 1px solid #e2e8f0;
        height: fit-content;
    }

    .sidebar-title {
        font-size: 1.3rem;
        font-weight: 700;
        color: #1e293b;
        margin-bottom: 1.5rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .template-list {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }

    .template-item {
        padding: 1rem;
        background: #f8fafc;
        border: 2px solid #e2e8f0;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
    }

    .template-item:hover {
        border-color: #3b82f6;
        background: #eff6ff;
        transform: translateX(5px);
    }

    .template-item.active {
        border-color: #3b82f6;
        background: #eff6ff;
        box-shadow: 0 5px 15px rgba(59, 130, 246, 0.2);
    }

    .template-item-name {
        font-weight: 600;
        color: #1e293b;
        margin-bottom: 0.25rem;
    }

    .template-item-type {
        font-size: 0.8rem;
        color: #64748b;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .template-item-actions {
        position: absolute;
        top: 0.5rem;
        right: 0.5rem;
        display: flex;
        gap: 0.25rem;
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .template-item:hover .template-item-actions {
        opacity: 1;
    }

    .btn-icon {
        width: 24px;
        height: 24px;
        border: none;
        border-radius: 6px;
        background: #3b82f6;
        color: white;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.7rem;
        transition: all 0.3s ease;
    }

    .btn-icon:hover {
        background: #2563eb;
        transform: scale(1.1);
    }

    .btn-icon.delete {
        background: #ef4444;
    }

    .btn-icon.delete:hover {
        background: #dc2626;
    }

    .template-editor {
        background: white;
        border-radius: 20px;
        padding: 2rem;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        border: 1px solid #e2e8f0;
    }

    .editor-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid #f1f5f9;
    }

    .editor-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: #1e293b;
    }

    .editor-actions {
        display: flex;
        gap: 1rem;
    }

    .btn-primary {
        padding: 0.75rem 1.5rem;
        background: linear-gradient(135deg, #3b82f6, #1e40af);
        color: white;
        border: none;
        border-radius: 10px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(59, 130, 246, 0.3);
    }

    .btn-secondary {
        padding: 0.75rem 1.5rem;
        background: #f3f4f6;
        color: #374151;
        border: 2px solid #e5e7eb;
        border-radius: 10px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }

    .btn-secondary:hover {
        background: #e5e7eb;
        color: #1f2937;
    }

    .form-grid {
        display: grid;
        gap: 1.5rem;
    }

    .form-group {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .form-label {
        font-weight: 600;
        color: #374151;
        font-size: 0.9rem;
    }

    .form-input {
        padding: 0.75rem 1rem;
        border: 2px solid #e5e7eb;
        border-radius: 10px;
        font-size: 0.95rem;
        transition: all 0.3s ease;
        background: #f9fafb;
    }

    .form-input:focus {
        outline: none;
        border-color: #3b82f6;
        background: white;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .form-textarea {
        min-height: 300px;
        resize: vertical;
        font-family: 'Courier New', monospace;
        line-height: 1.6;
    }

    .form-select {
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
        background-position: right 0.5rem center;
        background-repeat: no-repeat;
        background-size: 1.5em 1.5em;
        padding-right: 2.5rem;
    }

    .variables-panel {
        background: #f8fafc;
        border: 2px solid #e2e8f0;
        border-radius: 12px;
        padding: 1.5rem;
        margin-top: 1rem;
    }

    .variables-title {
        font-weight: 600;
        color: #1e293b;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .variables-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 0.75rem;
    }

    .variable-item {
        background: white;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 0.75rem;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .variable-item:hover {
        border-color: #3b82f6;
        background: #eff6ff;
    }

    .variable-name {
        font-weight: 600;
        color: #1e293b;
        font-size: 0.9rem;
        margin-bottom: 0.25rem;
    }

    .variable-desc {
        color: #64748b;
        font-size: 0.8rem;
    }

    .preview-panel {
        background: #f8fafc;
        border: 2px solid #e2e8f0;
        border-radius: 12px;
        padding: 1.5rem;
        margin-top: 1rem;
    }

    .preview-title {
        font-weight: 600;
        color: #1e293b;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .preview-content {
        background: white;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 1.5rem;
        min-height: 200px;
        white-space: pre-wrap;
        font-family: inherit;
        line-height: 1.6;
    }

    .add-template-btn {
        width: 100%;
        padding: 1rem;
        background: linear-gradient(135deg, #10b981, #059669);
        color: white;
        border: none;
        border-radius: 12px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        margin-top: 1rem;
    }

    .add-template-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3);
    }

    @media (max-width: 1024px) {
        .template-grid {
            grid-template-columns: 1fr;
        }
    }

    @media (max-width: 768px) {
        .template-manager-container {
            padding: 1rem;
        }

        .template-title {
            font-size: 2rem;
        }

        .editor-actions {
            flex-direction: column;
        }
    }
</style>

<div class="template-manager-container">
    <!-- Header -->
    <div class="template-header">
        <h1 class="template-title">
            <i class="fas fa-edit"></i>
            Email Template Manager
        </h1>
        <p class="template-subtitle">Create, edit, and manage professional email templates</p>
    </div>

    <!-- Main Content -->
    <div class="template-grid">
        <!-- Template Sidebar -->
        <div class="template-sidebar">
            <h2 class="sidebar-title">
                <i class="fas fa-list"></i>
                Templates
            </h2>
            
            <div class="template-list" id="templateList">
                <div class="template-item active" onclick="selectTemplate('renewal')">
                    <div class="template-item-name">Renewal Reminder</div>
                    <div class="template-item-type">SPO Rent</div>
                    <div class="template-item-actions">
                        <button class="btn-icon" onclick="editTemplate('renewal')" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn-icon delete" onclick="deleteTemplate('renewal')" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                
                <div class="template-item" onclick="selectTemplate('expiry')">
                    <div class="template-item-name">Expiry Notice</div>
                    <div class="template-item-type">CFA Agreement</div>
                    <div class="template-item-actions">
                        <button class="btn-icon" onclick="editTemplate('expiry')" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn-icon delete" onclick="deleteTemplate('expiry')" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                
                <div class="template-item" onclick="selectTemplate('payment')">
                    <div class="template-item-name">Payment Reminder</div>
                    <div class="template-item-type">General</div>
                    <div class="template-item-actions">
                        <button class="btn-icon" onclick="editTemplate('payment')" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn-icon delete" onclick="deleteTemplate('payment')" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                
                <div class="template-item" onclick="selectTemplate('welcome')">
                    <div class="template-item-name">Welcome Email</div>
                    <div class="template-item-type">General</div>
                    <div class="template-item-actions">
                        <button class="btn-icon" onclick="editTemplate('welcome')" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn-icon delete" onclick="deleteTemplate('welcome')" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <button class="add-template-btn" onclick="createNewTemplate()">
                <i class="fas fa-plus"></i>
                Create New Template
            </button>
        </div>

        <!-- Template Editor -->
        <div class="template-editor">
            <div class="editor-header">
                <h2 class="editor-title" id="editorTitle">Renewal Reminder Template</h2>
                <div class="editor-actions">
                    <button class="btn-secondary" onclick="previewTemplate()">
                        <i class="fas fa-eye"></i>
                        Preview
                    </button>
                    <button class="btn-secondary" onclick="testTemplate()">
                        <i class="fas fa-paper-plane"></i>
                        Test
                    </button>
                    <button class="btn-primary" onclick="saveTemplate()">
                        <i class="fas fa-save"></i>
                        Save Template
                    </button>
                </div>
            </div>

            <form class="form-grid" id="templateForm">
                <div class="form-group">
                    <label class="form-label">Template Name</label>
                    <input type="text" class="form-input" id="templateName" value="Renewal Reminder" required>
                </div>

                <div class="form-group">
                    <label class="form-label">Template Type</label>
                    <select class="form-input form-select" id="templateType">
                        <option value="spo_rent">SPO Rent</option>
                        <option value="cfa_agreement">CFA Agreement</option>
                        <option value="transporter">Transporter Agreement</option>
                        <option value="general">General</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Subject Line</label>
                    <input type="text" class="form-input" id="templateSubject" value="SPO Rent Agreement Renewal Reminder" required>
                </div>

                <div class="form-group">
                    <label class="form-label">Email Content</label>
                    <textarea class="form-input form-textarea" id="templateContent" required>Dear {{recipient_name}},

We hope this email finds you well. This is a friendly reminder that your SPO Rent Agreement for {{spo_name}} (Code: {{spo_code}}) is due for renewal.

Agreement Details:
- SPO Name: {{spo_name}}
- SPO Code: {{spo_code}}
- Current Expiry Date: {{expiry_date}}
- Branch: {{branch_name}}
- Monthly Rent: ₹{{monthly_rent}}

Please ensure all necessary documents are submitted before the renewal date to avoid any service interruptions.

If you have any questions or need assistance, please don't hesitate to contact us.

Best regards,
Chettinad Data Management Team</textarea>
                </div>

                <!-- Variables Panel -->
                <div class="variables-panel">
                    <h3 class="variables-title">
                        <i class="fas fa-code"></i>
                        Available Variables
                    </h3>
                    <div class="variables-grid">
                        <div class="variable-item" onclick="insertVariable('{{recipient_name}}')">
                            <div class="variable-name">{{recipient_name}}</div>
                            <div class="variable-desc">Recipient's full name</div>
                        </div>
                        <div class="variable-item" onclick="insertVariable('{{spo_name}}')">
                            <div class="variable-name">{{spo_name}}</div>
                            <div class="variable-desc">SPO business name</div>
                        </div>
                        <div class="variable-item" onclick="insertVariable('{{spo_code}}')">
                            <div class="variable-name">{{spo_code}}</div>
                            <div class="variable-desc">SPO unique code</div>
                        </div>
                        <div class="variable-item" onclick="insertVariable('{{expiry_date}}')">
                            <div class="variable-name">{{expiry_date}}</div>
                            <div class="variable-desc">Agreement expiry date</div>
                        </div>
                        <div class="variable-item" onclick="insertVariable('{{branch_name}}')">
                            <div class="variable-name">{{branch_name}}</div>
                            <div class="variable-desc">Branch location name</div>
                        </div>
                        <div class="variable-item" onclick="insertVariable('{{monthly_rent}}')">
                            <div class="variable-name">{{monthly_rent}}</div>
                            <div class="variable-desc">Monthly rent amount</div>
                        </div>
                        <div class="variable-item" onclick="insertVariable('{{owner_name}}')">
                            <div class="variable-name">{{owner_name}}</div>
                            <div class="variable-desc">Property owner name</div>
                        </div>
                        <div class="variable-item" onclick="insertVariable('{{contact_number}}')">
                            <div class="variable-name">{{contact_number}}</div>
                            <div class="variable-desc">Contact phone number</div>
                        </div>
                    </div>
                </div>

                <!-- Preview Panel -->
                <div class="preview-panel">
                    <h3 class="preview-title">
                        <i class="fas fa-eye"></i>
                        Live Preview
                    </h3>
                    <div class="preview-content" id="previewContent">
                        <!-- Preview content will be updated here -->
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    // Template Management JavaScript
    let currentTemplate = 'renewal';
    let templates = {
        renewal: {
            name: 'Renewal Reminder',
            type: 'spo_rent',
            subject: 'SPO Rent Agreement Renewal Reminder',
            content: `Dear {{recipient_name}},

We hope this email finds you well. This is a friendly reminder that your SPO Rent Agreement for {{spo_name}} (Code: {{spo_code}}) is due for renewal.

Agreement Details:
- SPO Name: {{spo_name}}
- SPO Code: {{spo_code}}
- Current Expiry Date: {{expiry_date}}
- Branch: {{branch_name}}
- Monthly Rent: ₹{{monthly_rent}}

Please ensure all necessary documents are submitted before the renewal date to avoid any service interruptions.

If you have any questions or need assistance, please don't hesitate to contact us.

Best regards,
Chettinad Data Management Team`
        },
        expiry: {
            name: 'Expiry Notice',
            type: 'cfa_agreement',
            subject: 'URGENT: CFA Agreement Expiry Notice',
            content: `Dear {{recipient_name}},

This is an urgent notification regarding your CFA Agreement which is expiring soon.

Agreement Details:
- CFA Name: {{cfa_name}}
- Agreement Number: {{agreement_number}}
- Expiry Date: {{expiry_date}}
- Branch: {{branch_name}}

Please take immediate action to renew your agreement to maintain uninterrupted services.

Best regards,
Chettinad Data Management Team`
        },
        payment: {
            name: 'Payment Reminder',
            type: 'general',
            subject: 'Payment Reminder - Outstanding Amount',
            content: `Dear {{recipient_name}},

This is a reminder for the outstanding payment amount of ₹{{amount}} for {{agreement_type}}.

Payment Details:
- Due Date: {{due_date}}
- Amount: ₹{{amount}}
- Reference: {{reference_number}}

Please process the payment at your earliest convenience to avoid any late fees.

Best regards,
Chettinad Data Management Team`
        },
        welcome: {
            name: 'Welcome Email',
            type: 'general',
            subject: 'Welcome to Chettinad Data Management System',
            content: `Dear {{recipient_name}},

Welcome to the Chettinad Data Management System! We're excited to have you on board.

Your account has been successfully created with the following details:
- Username: {{username}}
- Email: {{email}}
- Role: {{role}}

Please log in to your account and complete your profile setup.

If you need any assistance, our support team is here to help.

Best regards,
Chettinad Data Management Team`
        }
    };

    // Template Selection
    function selectTemplate(templateId) {
        // Update active template in sidebar
        document.querySelectorAll('.template-item').forEach(item => {
            item.classList.remove('active');
        });
        event.currentTarget.classList.add('active');
        
        // Load template data
        currentTemplate = templateId;
        loadTemplateData(templateId);
    }

    function loadTemplateData(templateId) {
        const template = templates[templateId];
        if (template) {
            document.getElementById('editorTitle').textContent = template.name + ' Template';
            document.getElementById('templateName').value = template.name;
            document.getElementById('templateType').value = template.type;
            document.getElementById('templateSubject').value = template.subject;
            document.getElementById('templateContent').value = template.content;
            updatePreview();
        }
    }

    // Template Actions
    function createNewTemplate() {
        const templateName = prompt('Enter template name:');
        if (templateName) {
            const templateId = templateName.toLowerCase().replace(/\s+/g, '_');
            templates[templateId] = {
                name: templateName,
                type: 'general',
                subject: '',
                content: ''
            };
            
            // Add to sidebar
            addTemplateToSidebar(templateId, templateName);
            
            // Select the new template
            selectTemplate(templateId);
        }
    }

    function addTemplateToSidebar(templateId, templateName) {
        const templateList = document.getElementById('templateList');
        const templateItem = document.createElement('div');
        templateItem.className = 'template-item';
        templateItem.onclick = () => selectTemplate(templateId);
        templateItem.innerHTML = `
            <div class="template-item-name">${templateName}</div>
            <div class="template-item-type">General</div>
            <div class="template-item-actions">
                <button class="btn-icon" onclick="editTemplate('${templateId}')" title="Edit">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="btn-icon delete" onclick="deleteTemplate('${templateId}')" title="Delete">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        `;
        templateList.appendChild(templateItem);
    }

    function editTemplate(templateId) {
        event.stopPropagation();
        selectTemplate(templateId);
    }

    function deleteTemplate(templateId) {
        event.stopPropagation();
        if (confirm('Are you sure you want to delete this template?')) {
            delete templates[templateId];
            event.currentTarget.closest('.template-item').remove();
            
            // Select first available template
            const firstTemplate = document.querySelector('.template-item');
            if (firstTemplate) {
                firstTemplate.click();
            }
        }
    }

    function saveTemplate() {
        const name = document.getElementById('templateName').value;
        const type = document.getElementById('templateType').value;
        const subject = document.getElementById('templateSubject').value;
        const content = document.getElementById('templateContent').value;
        
        if (!name || !subject || !content) {
            alert('Please fill in all required fields');
            return;
        }
        
        // Update template data
        templates[currentTemplate] = {
            name: name,
            type: type,
            subject: subject,
            content: content
        };
        
        // Update sidebar
        const templateItem = document.querySelector('.template-item.active');
        if (templateItem) {
            templateItem.querySelector('.template-item-name').textContent = name;
            templateItem.querySelector('.template-item-type').textContent = type.replace('_', ' ').toUpperCase();
        }
        
        alert('Template saved successfully!');
    }

    function previewTemplate() {
        updatePreview();
        alert('Preview updated! Check the preview panel below.');
    }

    function testTemplate() {
        const testEmail = prompt('Enter test email address:');
        if (testEmail) {
            // Simulate sending test email
            alert(`Test email sent to ${testEmail}`);
        }
    }

    // Variable Insertion
    function insertVariable(variable) {
        const textarea = document.getElementById('templateContent');
        const start = textarea.selectionStart;
        const end = textarea.selectionEnd;
        const text = textarea.value;
        
        textarea.value = text.substring(0, start) + variable + text.substring(end);
        textarea.focus();
        textarea.setSelectionRange(start + variable.length, start + variable.length);
        
        updatePreview();
    }

    // Preview Update
    function updatePreview() {
        const content = document.getElementById('templateContent').value;
        const preview = document.getElementById('previewContent');
        
        // Replace variables with sample data
        const sampleData = {
            '{{recipient_name}}': 'John Doe',
            '{{spo_name}}': 'Sample SPO Business',
            '{{spo_code}}': 'E001',
            '{{expiry_date}}': '2025-08-31',
            '{{branch_name}}': 'Chennai Branch',
            '{{monthly_rent}}': '25,000',
            '{{owner_name}}': 'Property Owner',
            '{{contact_number}}': '+91 98765 43210',
            '{{cfa_name}}': 'Sample CFA',
            '{{agreement_number}}': 'CFA-2025-001',
            '{{amount}}': '50,000',
            '{{agreement_type}}': 'SPO Rent Agreement',
            '{{due_date}}': '2025-08-15',
            '{{reference_number}}': 'REF-2025-001',
            '{{username}}': 'johndoe',
            '{{email}}': 'john.doe@example.com',
            '{{role}}': 'SPO Manager'
        };
        
        let previewContent = content;
        Object.keys(sampleData).forEach(variable => {
            previewContent = previewContent.replace(new RegExp(variable, 'g'), sampleData[variable]);
        });
        
        preview.textContent = previewContent;
    }

    // Event Listeners
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize with first template
        loadTemplateData('renewal');
        
        // Add event listeners for real-time preview
        document.getElementById('templateContent').addEventListener('input', updatePreview);
        document.getElementById('templateSubject').addEventListener('input', updatePreview);
    });
</script>
{% endblock %} 