{% extends 'dashboard/base.html' %}
{% load static %}
{% load custom_filters %}
{% csrf_token %}

{% block title %}Mail Reminder - Data Management System{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row justify-content-center">
        <div class="col-lg-12 col-md-12 col-sm-12">
            <!-- Header -->
            <div class="card shadow-sm mb-4">
                <div class="card-header py-3">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-envelope text-primary"></i> Mail Reminder Dashboard
                    </h5>
                </div>
                <div class="card-body p-4">
                    <div class="row g-3">
                        <div class="col-md-3 col-sm-6 mb-3">
                            <div class="stat-card bg-primary text-white">
                                <div class="stat-number">{{ total_spo_records }}</div>
                                <div class="stat-label">Total Records</div>
                            </div>
                        </div>
                        <div class="col-md-3 col-sm-6 mb-3">
                            <div class="stat-card bg-success text-white">
                                <div class="stat-number">{{ records_with_email }}</div>
                                <div class="stat-label">With Email</div>
                            </div>
                        </div>
                        <div class="col-md-3 col-sm-6 mb-3">
                            <div class="stat-card bg-info text-white">
                                <div class="stat-number">{{ active_records }}</div>
                                <div class="stat-label">Active</div>
                            </div>
                        </div>
                        <div class="col-md-3 col-sm-6 mb-3">
                            <div class="stat-card bg-warning text-white">
                                <div class="stat-number">{{ expiring_soon }}</div>
                                <div class="stat-label">Expiring Soon</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Data Table -->
            {% if expiry_data %}
            <div class="card shadow-sm mb-4">
                <div class="card-header py-3">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-table text-success"></i> Agreement Expiry Information
                        <small class="text-muted ms-2">(Auto-trigger: 6 days before expiry)</small>
                    </h5>
                </div>
                <div class="card-body p-4">
                    <div class="table-responsive">
                        <table class="table table-hover table-striped expanded-table">
                            <thead class="table-dark">
                                <tr>
                                    <th class="py-3 px-4">SPO Code</th>
                                    <th class="py-3 px-4">Name</th>
                                    <th class="py-3 px-4">Owner</th>
                                    <th class="py-3 px-4">Branch</th>
                                    <th class="py-3 px-4">Expiry Date</th>
                                    <th class="py-3 px-4">Days Remaining</th>
                                    <th class="py-3 px-4">Status</th>
                                    <th class="py-3 px-4">Email</th>
                                    <th class="py-3 px-4">Mail Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in expiry_data %}
                                <tr class="table-row-expanded" data-record-id="{{ item.id }}" data-email="{{ item.email }}" data-spo-name="{{ item.spo_name }}" data-expiry-date="{{ item.expiry_date|date:'d/m/Y' }}">
                                    <td class="py-3 px-4"><strong>{{ item.spo_code }}</strong></td>
                                    <td class="py-3 px-4">{{ item.spo_name|truncatechars:25 }}</td>
                                    <td class="py-3 px-4">{{ item.owner_name|truncatechars:20 }}</td>
                                    <td class="py-3 px-4">{{ item.branch_name|truncatechars:20 }}</td>
                                    <td class="py-3 px-4">
                                        <span class="expiry-date">{{ item.expiry_date|date:"d/m/Y" }}</span>
                                    </td>
                                    <td class="py-3 px-4">
                                        {% if item.status == 'expired' %}
                                            <span class="badge bg-danger badge-lg">Expired {{ item.days_expired }} days ago</span>
                                        {% elif item.status == 'expiring_soon' %}
                                            {% if item.days_until_expiry <= 6 %}
                                                <span class="badge bg-warning badge-lg urgent-warning">{{ item.days_until_expiry }} days left - URGENT!</span>
                                            {% else %}
                                                <span class="badge bg-warning badge-lg">{{ item.days_until_expiry }} days left</span>
                                            {% endif %}
                                        {% else %}
                                            <span class="badge bg-success badge-lg">{{ item.days_until_expiry }} days left</span>
                                        {% endif %}
                                    </td>
                                    <td class="py-3 px-4">
                                        <span class="badge bg-{{ item.status|status_color }} badge-lg">{{ item.status|title }}</span>
                                    </td>
                                    <td class="py-3 px-4">
                                        <span class="email-address">{{ item.email|truncatechars:30 }}</span>
                                    </td>
                                    <td class="py-3 px-4">
                                        <div class="mail-actions">
                                            {% if item.status == 'expiring_soon' and item.days_until_expiry <= 6 %}
                                                <button class="btn btn-warning btn-sm send-reminder-btn" 
                                                        data-record-id="{{ item.id }}" 
                                                        data-email="{{ item.email }}"
                                                        data-spo-name="{{ item.spo_name }}"
                                                        data-days-left="{{ item.days_until_expiry }}">
                                                    <i class="fas fa-paper-plane"></i> Send Reminder
                                                </button>
                                                <div class="auto-trigger-info">
                                                    <small class="text-warning">
                                                        <i class="fas fa-clock"></i> Auto-trigger in {{ item.days_until_expiry }} days
                                                    </small>
                                                </div>
                                            {% elif item.status == 'expired' %}
                                                <button class="btn btn-danger btn-sm send-reminder-btn" 
                                                        data-record-id="{{ item.id }}" 
                                                        data-email="{{ item.email }}"
                                                        data-spo-name="{{ item.spo_name }}"
                                                        data-days-expired="{{ item.days_expired }}">
                                                    <i class="fas fa-exclamation-triangle"></i> Send Overdue Notice
                                                </button>
                                            {% else %}
                                                <button class="btn btn-info btn-sm send-reminder-btn" 
                                                        data-record-id="{{ item.id }}" 
                                                        data-email="{{ item.email }}"
                                                        data-spo-name="{{ item.spo_name }}"
                                                        data-days-left="{{ item.days_until_expiry }}">
                                                    <i class="fas fa-envelope"></i> Send Info
                                                </button>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Reminder Types Table -->
            <div class="card shadow-sm mb-4">
                <div class="card-header py-3">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-bell text-warning"></i> Reminder Types & Auto-Triggers
                    </h5>
                </div>
                <div class="card-body p-4">
                    <div class="table-responsive">
                        <table class="table table-hover table-striped expanded-table">
                            <thead class="table-light">
                                <tr>
                                    <th class="py-3 px-4">Type</th>
                                    <th class="py-3 px-4">Description</th>
                                    <th class="py-3 px-4">Count</th>
                                    <th class="py-3 px-4">Status</th>
                                    <th class="py-3 px-4">Auto-Trigger</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for reminder in reminder_types %}
                                <tr class="table-row-expanded">
                                    <td class="py-3 px-4">
                                        <i class="{{ reminder.icon }} text-primary me-2"></i>
                                        {{ reminder.name }}
                                    </td>
                                    <td class="py-3 px-4">{{ reminder.description|truncatechars:50 }}</td>
                                    <td class="py-3 px-4">
                                        <span class="badge bg-primary badge-lg">{{ reminder.count }}</span>
                                    </td>
                                    <td class="py-3 px-4">
                                        <span class="badge bg-success badge-lg">{{ reminder.status|title }}</span>
                                    </td>
                                    <td class="py-3 px-4">
                                        {% if reminder.name == 'SPO Rent Renewal' %}
                                            <span class="badge bg-info badge-lg">6 days before expiry</span>
                                        {% else %}
                                            <span class="badge bg-secondary badge-lg">Manual only</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>


        </div>
    </div>
</div>

<!-- Mail Sending Modal -->
<div class="modal fade" id="mailModal" tabindex="-1" aria-labelledby="mailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="mailModalLabel">
                    <i class="fas fa-envelope"></i> Send Mail Reminder
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Recipient Details:</h6>
                        <p><strong>SPO Name:</strong> <span id="modalSpoName"></span></p>
                        <p><strong>Email:</strong> <span id="modalEmail"></span></p>
                        <p><strong>Expiry Date:</strong> <span id="modalExpiryDate"></span></p>
                        <p><strong>Days Left:</strong> <span id="modalDaysLeft"></span></p>
                    </div>
                    <div class="col-md-6">
                        <h6>Mail Content:</h6>
                        <div class="form-group">
                            <label for="mailSubject">Subject:</label>
                            <input type="text" class="form-control" id="mailSubject" value="SPO Rent Agreement Renewal Reminder">
                        </div>
                        <div class="form-group mt-3">
                            <label for="mailMessage">Message:</label>
                            <textarea class="form-control" id="mailMessage" rows="4" placeholder="Enter your message here..."></textarea>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="sendMailBtn">
                    <i class="fas fa-paper-plane"></i> Send Mail
                </button>
            </div>
        </div>
    </div>
</div>

<style>
/* Expanded Table Design with Increased Spacing */
.card {
    border-radius: 8px;
    border: 1px solid #dee2e6;
    margin-bottom: 1rem;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

.card-header {
    background-color: #f8f9fa;
    border-bottom: 2px solid #dee2e6;
    padding: 1rem;
}

.card-body {
    padding: 1.5rem;
}

/* Enhanced Statistics Cards */
.stat-card {
    padding: 1.5rem;
    border-radius: 8px;
    text-align: center;
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    min-height: 100px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    transition: transform 0.3s ease;
}

.stat-card:hover {
    transform: translateY(-5px);
}

.stat-number {
    font-size: 28px;
    font-weight: 700;
    margin-bottom: 8px;
    line-height: 1;
}

.stat-label {
    font-size: 14px;
    font-weight: 600;
    opacity: 0.9;
    line-height: 1.2;
}

/* Expanded Table Styles */
.expanded-table {
    margin-bottom: 0;
    font-size: 14px;
    border: 2px solid #dee2e6;
}

.expanded-table th {
    font-size: 13px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    background-color: #343a40;
    color: white;
    border-bottom: 3px solid #495057;
    text-align: center;
}

.expanded-table td {
    font-size: 14px;
    vertical-align: middle;
    border-bottom: 2px solid #e9ecef;
    text-align: center;
}

.table-row-expanded:hover {
    background-color: #f8f9fa;
    transform: scale(1.01);
    transition: all 0.3s ease;
}

/* Enhanced Badges */
.badge-lg {
    font-size: 12px;
    padding: 8px 12px;
    border-radius: 6px;
    font-weight: 600;
}

.urgent-warning {
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.7; }
    100% { opacity: 1; }
}

/* Mail Actions Styling */
.mail-actions {
    display: flex;
    flex-direction: column;
    gap: 8px;
    align-items: center;
}

.send-reminder-btn {
    min-width: 140px;
    font-weight: 600;
    transition: all 0.3s ease;
}

.send-reminder-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}

.auto-trigger-info {
    text-align: center;
    margin-top: 5px;
}

/* Modal Styling */
.modal-header {
    border-bottom: 2px solid #dee2e6;
}

.modal-footer {
    border-top: 2px solid #dee2e6;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .col-lg-12 {
        max-width: 100%;
    }
    
    .stat-card {
        padding: 1rem;
        min-height: 80px;
    }
    
    .stat-number {
        font-size: 24px;
    }
    
    .expanded-table {
        font-size: 12px;
    }
    
    .expanded-table th,
    .expanded-table td {
        padding: 0.75rem 1rem;
    }
    
    .send-reminder-btn {
        min-width: 120px;
        font-size: 12px;
    }
}

/* Enhanced spacing */
.mb-3 { margin-bottom: 1rem !important; }
.mb-4 { margin-bottom: 1.5rem !important; }
.py-3 { padding-top: 1rem !important; padding-bottom: 1rem !important; }
.px-4 { padding-left: 1.5rem !important; padding-right: 1.5rem !important; }
.p-4 { padding: 1.5rem !important; }
.g-3 { --bs-gutter-x: 1rem; --bs-gutter-y: 1rem; }

/* Table hover effects */
.table-hover tbody tr:hover {
    background-color: rgba(0,123,255,0.08);
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

/* Striped table */
.table-striped tbody tr:nth-of-type(odd) {
    background-color: rgba(0,0,0,.03);
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Add row highlighting on hover
    const tableRows = document.querySelectorAll('.table-row-expanded');
    tableRows.forEach(row => {
        row.addEventListener('mouseenter', function() {
            this.style.backgroundColor = '#f8f9fa';
        });
        
        row.addEventListener('mouseleave', function() {
            this.style.backgroundColor = '';
        });
    });
    
    // Add click to highlight functionality
    tableRows.forEach(row => {
        row.addEventListener('click', function() {
            // Remove highlight from all rows
            tableRows.forEach(r => r.classList.remove('table-active'));
            // Add highlight to clicked row
            this.classList.add('table-active');
        });
    });
    
    // Mail sending functionality
    const sendButtons = document.querySelectorAll('.send-reminder-btn');
    const mailModal = new bootstrap.Modal(document.getElementById('mailModal'));
    
    sendButtons.forEach(button => {
        button.addEventListener('click', function() {
            const recordId = this.getAttribute('data-record-id');
            const email = this.getAttribute('data-email');
            const spoName = this.getAttribute('data-spo-name');
            const expiryDate = this.getAttribute('data-expiry-date');
            const daysLeft = this.getAttribute('data-days-left');
            const daysExpired = this.getAttribute('data-days-expired');
            
            // Populate modal
            document.getElementById('modalSpoName').textContent = spoName;
            document.getElementById('modalEmail').textContent = email;
            document.getElementById('modalExpiryDate').textContent = expiryDate;
            
            if (daysLeft) {
                document.getElementById('modalDaysLeft').textContent = daysLeft + ' days left';
                document.getElementById('mailSubject').value = 'SPO Rent Agreement Renewal Reminder - ' + daysLeft + ' days left';
            } else if (daysExpired) {
                document.getElementById('modalDaysLeft').textContent = daysExpired + ' days expired';
                document.getElementById('mailSubject').value = 'SPO Rent Agreement Overdue Notice - ' + daysExpired + ' days expired';
            }
            
            // Show modal
            mailModal.show();
        });
    });
    
    // Send mail functionality
    document.getElementById('sendMailBtn').addEventListener('click', function() {
        const subject = document.getElementById('mailSubject').value;
        const message = document.getElementById('mailMessage').value;
        const email = document.getElementById('modalEmail').textContent;
        const spoName = document.getElementById('modalSpoName').textContent;
        const recordId = document.querySelector('.send-reminder-btn[data-email="' + email + '"]').getAttribute('data-record-id');
        
        // Show loading state
        const sendBtn = this;
        const originalText = sendBtn.innerHTML;
        sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';
        sendBtn.disabled = true;
        
        // Send AJAX request
        fetch('{% url "send_spo_reminder_mail" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: new URLSearchParams({
                'record_id': recordId,
                'email': email,
                'spo_name': spoName,
                'subject': subject,
                'message': message
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Show success message
                alert('✓ ' + data.message);
                
                // Update the button to show sent status
                const originalButton = document.querySelector('.send-reminder-btn[data-email="' + email + '"]');
                originalButton.innerHTML = '<i class="fas fa-check"></i> Sent';
                originalButton.classList.remove('btn-warning', 'btn-danger', 'btn-info');
                originalButton.classList.add('btn-success');
                originalButton.disabled = true;
                
                // Close modal
                mailModal.hide();
            } else {
                // Show error message
                alert('✗ Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('✗ Network error occurred while sending mail');
        })
        .finally(() => {
            // Reset button state
            sendBtn.innerHTML = originalText;
            sendBtn.disabled = false;
        });
    });
    
    // Auto-trigger simulation (for demonstration)
    function checkAutoTriggers() {
        const urgentRows = document.querySelectorAll('.urgent-warning');
        urgentRows.forEach(row => {
            const daysLeft = parseInt(row.textContent.match(/(\d+)/)[1]);
            if (daysLeft <= 3) {
                console.log('Auto-triggering mail for urgent case:', daysLeft, 'days left');
                // Here you would implement automatic mail sending
            }
        });
    }
    
    // Check auto-triggers every hour
    setInterval(checkAutoTriggers, 3600000); // 1 hour
    checkAutoTriggers(); // Initial check
});
</script>
{% endblock %} 